name: Deploy MarinaObuv with PM2

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 60
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Cancel previous deployments
        run: |
          echo "ğŸ›‘ Cancelling all previous workflow runs..."
          gh api repos/${{ github.repository }}/actions/runs --jq '.workflow_runs[] | select(.status == "in_progress" and .id != ${{ github.run_id }}) | .id' | xargs -I {} gh api repos/${{ github.repository }}/actions/runs/{}/cancel -X POST || echo "No previous runs to cancel"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for cancellations
        run: |
          echo "â³ Waiting for previous runs to be cancelled..."
          sleep 15
          echo "âœ… Ready to proceed with new deployment"

      - name: Cancel previous deployments (backup)
        uses: nick-invision/retry@v2
        with:
          timeout_minutes: 10
          max_attempts: 5
          command: |
            echo "ğŸ”„ Checking for previous deployments to cancel..."

            # Get all in-progress workflow runs for this repository
            RUNS=$(gh api repos/${{ github.repository }}/actions/runs --jq '.workflow_runs[] | select(.status == "in_progress" and .id != ${{ github.run_id }}) | .id')

            if [ ! -z "$RUNS" ]; then
              echo "ğŸ›‘ Found previous deployments to cancel: $RUNS"
              for run_id in $RUNS; do
                echo "ğŸ›‘ Cancelling deployment run: $run_id"
                gh api repos/${{ github.repository }}/actions/runs/$run_id/cancel -X POST || echo "Failed to cancel run $run_id"
                sleep 2
              done

              # Wait a bit for cancellations to take effect
              echo "â³ Waiting for cancellations to take effect..."
              sleep 10

              # Check if any are still running
              REMAINING=$(gh api repos/${{ github.repository }}/actions/runs --jq '.workflow_runs[] | select(.status == "in_progress" and .id != ${{ github.run_id }}) | .id')
              if [ ! -z "$REMAINING" ]; then
                echo "âš ï¸ Some deployments are still running: $REMAINING"
                echo "ğŸ”„ Attempting force cancellation..."
                for run_id in $REMAINING; do
                  gh api repos/${{ github.repository }}/actions/runs/$run_id/cancel -X POST || echo "Force cancel failed for run $run_id"
                done
              else
                echo "âœ… All previous deployments cancelled successfully"
              fi
            else
              echo "âœ… No previous deployments found to cancel"
            fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout code
        uses: actions/checkout@v4

      # Skip artifact download: we rebuild on server to avoid stale/overwriting files
      # - name: Download build artifacts
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: build-artifacts
      #     path: web/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        run: |
          npm ci
          cd web && npm ci

      - name: Run linting
        run: |
          cd web && npm run lint:check

      - name: Run type checking
        run: |
          cd web && npm run typecheck

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 1200s
          command_timeout: 1800s
          debug: true
          use_insecure_cipher: false
          cipher: aes128-ctr,aes192-ctr,aes256-ctr
          script_stop: true
          request_pty: false
          script: |
            set -e

            # Ensure application directory exists and repo is cloned
            if [ ! -d "/var/www/marinaobuv/.git" ]; then
              echo "Setting up /var/www/marinaobuv..."
              sudo mkdir -p /var/www/marinaobuv
              sudo chown -R $USER:$USER /var/www/marinaobuv
              git clone https://github.com/singladno/marinaobuv.git /var/www/marinaobuv
            fi

            cd /var/www/marinaobuv

            echo "ğŸ” Refreshing repository from origin/main..."
            git fetch origin main
            git reset --hard origin/main
            git clean -fd
            echo "âœ… Repository reset to origin/main"

            # Make sure the deploy script is executable
            chmod +x scripts/remote-deploy.sh

            echo "ğŸš€ Running remote deployment script..."
            ./scripts/remote-deploy.sh

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed!"
          fi

  deploy-proxy:
    needs: deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy proxy server to serverspace
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROXY_SSH_HOST }}
          username: ${{ secrets.PROXY_SSH_USER }}
          key: ${{ secrets.PROXY_SSH_PRIVATE_KEY }}
          port: ${{ secrets.PROXY_SSH_PORT }}
          timeout: 300s
          command_timeout: 300s
          debug: true
          script: |
            echo "ğŸš€ Starting proxy server deployment on serverspace..."

            # Create proxy directory if it doesn't exist
            mkdir -p /root/proxy

            # Stop and remove any existing groq-proxy processes
            echo "ğŸ›‘ Stopping existing groq-proxy processes..."
            pm2 stop groq-proxy 2>/dev/null || true
            pm2 delete groq-proxy 2>/dev/null || true

            # Kill any processes using port 8787
            echo "ğŸ” Checking for port conflicts on port 8787..."
            if lsof -i :8787 >/dev/null 2>&1; then
                echo "âš ï¸  Port 8787 is in use, killing existing processes..."
                lsof -ti :8787 | xargs kill -9 2>/dev/null || true
                sleep 2
            fi

            # Copy proxy server files from git
            echo "ğŸ“ Setting up proxy server files..."
            cd /root
            if [ -d "proxy-backup" ]; then
                rm -rf proxy-backup
            fi
            if [ -d "proxy" ]; then
                mv proxy proxy-backup
            fi

            # Clone the repository to get the latest proxy files
            git clone https://github.com/singladno/marinaobuv.git temp-repo
            cp -r temp-repo/proxy /root/
            rm -rf temp-repo

            # Set proper permissions
            chmod +x /root/proxy/server.js

            # Install dependencies
            echo "ğŸ“¦ Installing proxy server dependencies..."
            cd /root/proxy
            npm install --production

            # Start the proxy server with PM2
            echo "ğŸš€ Starting groq-proxy with PM2..."
            PORT=8787 pm2 start server.js --name groq-proxy --env production

            # Save PM2 configuration
            pm2 save

            # Wait for server to start
            echo "â³ Waiting for proxy server to start..."
            sleep 5

            # Test the proxy server
            echo "ğŸ§ª Testing proxy server..."
            if curl -f http://localhost:8787/healthz >/dev/null 2>&1; then
                echo "âœ… Proxy server is running successfully!"
                echo "ğŸ“Š Proxy server status:"
                pm2 status groq-proxy
            else
                echo "âŒ Proxy server failed to start!"
                echo "ğŸ“‹ Proxy server logs:"
                pm2 logs groq-proxy --lines 10
                exit 1
            fi

            echo "ğŸ‰ Proxy server deployment completed successfully!"
            echo "âœ… Proxy server is running on port 8787"
            echo "âœ… PM2 is managing the proxy server"
