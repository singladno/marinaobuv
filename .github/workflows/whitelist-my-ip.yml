name: Whitelist My IP

on:
  workflow_dispatch:  # Manual trigger
  push:
    paths:
      - '.github/workflows/whitelist-my-ip.yml'

jobs:
  whitelist-ip:
    runs-on: ubuntu-latest
    steps:
      - name: Get My IP
        id: get-ip
        run: |
          # Get the GitHub Actions runner's public IP
          # This is the IP that GitHub Actions uses, which may be different from your local IP
          RUNNER_IP=$(curl -s --max-time 5 ifconfig.me || curl -s --max-time 5 icanhazip.com || echo "")
          echo "Runner IP: $RUNNER_IP"
          echo "ip=$RUNNER_IP" >> $GITHUB_OUTPUT

          # Also show instructions for local IP
          echo ""
          echo "⚠️  NOTE: This whitelists the GitHub Actions runner IP."
          echo "   If you want to whitelist YOUR local IP, run this locally:"
          echo "   curl -s ifconfig.me"
          echo "   Then manually add it via the server script."

      - name: Whitelist IP on Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 10s
          command_timeout: 10s
          script: |
            MY_IP="${{ steps.get-ip.outputs.ip }}"
            echo "Whitelisting IP: $MY_IP"

            # Backup config
            sudo cp /etc/fail2ban/jail.local /etc/fail2ban/jail.local.backup.$(date +%Y%m%d_%H%M%S) 2>/dev/null || true

            # Add to whitelist
            if grep -q "^ignoreip = " /etc/fail2ban/jail.local 2>/dev/null; then
              if ! grep -q "$MY_IP" /etc/fail2ban/jail.local; then
                sudo sed -i "/^ignoreip = /s/$/ $MY_IP/" /etc/fail2ban/jail.local
                echo "✅ Added $MY_IP to existing ignoreip line"
              else
                echo "✅ IP $MY_IP already whitelisted"
              fi
            else
              sudo sed -i "/^\[DEFAULT\]/a ignoreip = 127.0.0.1/8 ::1 $MY_IP" /etc/fail2ban/jail.local
              echo "✅ Created new ignoreip line with $MY_IP"
            fi

            # Unban if banned
            sudo fail2ban-client set sshd unbanip "$MY_IP" 2>/dev/null || echo "Not banned"

            # Restart Fail2Ban
            sudo systemctl restart fail2ban

            echo "✅ IP $MY_IP whitelisted and Fail2Ban restarted"
            echo ""
            echo "Current Fail2Ban status:"
            sudo fail2ban-client status sshd | head -10
