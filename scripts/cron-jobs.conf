# MarinaObuv Cron Jobs (managed by install-crons.sh)
# Each line should end with a unique marker comment for idempotent updates

# Daily DB backup at 03:00 (keeps 3 backups via script retention)
# Disable with: DISABLE_CRON_BACKUP=true
0 3 * * * cd /var/www/marinaobuv/web && export $(grep -v '^#' ./.env | xargs) && [ "$DISABLE_CRON_BACKUP" != "true" ] && /usr/bin/env ./node_modules/.bin/tsx scripts/backup-database.ts >> /var/www/marinaobuv/web/logs/backup.log 2>&1 # JOB:db-backup

# Groq parser cron (every 4 hours)
# Disable with: DISABLE_CRON_PARSING=true
0 */4 * * * cd /var/www/marinaobuv/web && NODE_ENV=production [ "$DISABLE_CRON_PARSING" != "true" ] && /usr/bin/env ./node_modules/.bin/tsx src/scripts/groq-sequential-cron.ts >> /var/www/marinaobuv/web/logs/parsing-cron.log 2>&1 # JOB:parser-hourly

# Poll Green API incoming queue every 5 minutes (drains queued webhooks)
# Disable with: DISABLE_CRON_QUEUE=true
*/5 * * * * cd /var/www/marinaobuv/web && NODE_ENV=production [ "$DISABLE_CRON_QUEUE" != "true" ] && POLL_MAX=200 /usr/bin/env ./node_modules/.bin/tsx src/scripts/poll-green-api-queue.ts >> /var/www/marinaobuv/web/logs/green-queue.log 2>&1 # JOB:green-queue

# Batch polling every 5 minutes (processes completed OpenAI batches)
# Disable with: DISABLE_CRON_BATCH_POLL=true
*/5 * * * * cd /var/www/marinaobuv/web && NODE_ENV=production [ "$DISABLE_CRON_BATCH_POLL" != "true" ] && /usr/bin/env ./node_modules/.bin/tsx src/scripts/batch-poll-v2.ts >> /var/www/marinaobuv/web/logs/batch-poll.log 2>&1 # JOB:batch-poll

# Groq proxy auto-restart monitoring every 2 minutes
# Disable with: DISABLE_CRON_PROXY_MONITOR=true
*/2 * * * * cd /var/www/marinaobuv && [ "$DISABLE_CRON_PROXY_MONITOR" != "true" ] && /usr/bin/env ./scripts/auto-restart-proxy.sh >> /var/www/marinaobuv/logs/proxy-cron.log 2>&1 # JOB:proxy-monitor

# Webhook configuration check every 5 minutes (ensures incoming messages webhook is always enabled)
# Disable with: DISABLE_CRON_WEBHOOK_CONFIG=true
*/5 * * * * cd /var/www/marinaobuv/web && NODE_ENV=production [ "$DISABLE_CRON_WEBHOOK_CONFIG" != "true" ] && /usr/bin/env ./node_modules/.bin/tsx src/scripts/configure-webhook.ts >> /var/www/marinaobuv/web/logs/webhook-config.log 2>&1 # JOB:webhook-config

# Webhook status monitoring every 15 minutes (sends notifications if webhook is not working)
# Disable with: DISABLE_CRON_WEBHOOK_MONITOR=true
*/15 * * * * cd /var/www/marinaobuv/web && NODE_ENV=production [ "$DISABLE_CRON_WEBHOOK_MONITOR" != "true" ] && /usr/bin/env ./node_modules/.bin/tsx src/scripts/webhook-status-monitor.ts >> /var/www/marinaobuv/web/logs/webhook-monitor.log 2>&1 # JOB:webhook-monitor

# Daily product export to Bitrix (runs at 02:00 daily, exports only new/updated products since last export)
# On first run, exports all products. Subsequent runs export only new/updated products.
# Disable with: DISABLE_CRON_PRODUCT_EXPORT=true
0 2 * * * cd /var/www/marinaobuv/web && NODE_ENV=production [ "$DISABLE_CRON_PRODUCT_EXPORT" != "true" ] && /usr/bin/env ./node_modules/.bin/tsx src/scripts/product-export-cron.ts >> /var/www/marinaobuv/web/logs/product-export.log 2>&1 # JOB:product-export
