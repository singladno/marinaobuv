# Экспорт товаров для интеграции с Bitrix

Система регулярной выгрузки товаров из портала MarinaObuv для интеграции с внешними системами (например, Bitrix).

## Возможности

- ✅ **Автоматическая ежедневная выгрузка** новых и обновленных товаров
- ✅ **Поддержка форматов CSV и XML** (совместимо с Bitrix)
- ✅ **Инкрементальный экспорт** - только новые/измененные товары с момента последней выгрузки
- ✅ **Ручной экспорт** через API для администраторов
- ✅ **Автоматическая очистка** старых файлов (хранятся последние 7 дней)

## Форматы экспорта

### CSV формат
- Кодировка: UTF-8 с BOM (для корректного отображения в Excel)
- Разделитель: запятая
- Поля: ID, Название, Артикул, Категория, Цена, Валюта, Материал, Пол, Сезон, Описание, Размеры, Изображения, Активен, Даты, URL

### XML формат
- Кодировка: UTF-8
- Структура: `<products><product>...</product></products>`
- Содержит все те же поля, что и CSV, в структурированном виде

## Роли и доступ

### Роли с доступом к экспорту

- **ADMIN** — полный доступ ко всем функциям экспорта
- **EXPORT_MANAGER** — доступ только к функциям экспорта товаров

Пользователи с ролью `EXPORT_MANAGER` могут:
- Экспортировать товары через API
- Просматривать список доступных экспортов
- Скачивать файлы экспорта

Пользователи с ролью `EXPORT_MANAGER` **не могут**:
- Управлять товарами
- Изменять настройки системы
- Доступ к другим административным функциям

### Назначение роли

Роль можно назначить через админ-панель при создании или редактировании пользователя.

## Использование

### Автоматическая выгрузка (рекомендуется)

Система автоматически выгружает товары каждый день в **02:00** по серверному времени.

**Расположение файлов:**

1. **Локально на сервере:**
   - `web/exports/products-export-YYYY-MM-DD.csv`
   - `web/exports/products-export-YYYY-MM-DD.xml`

2. **В облачном хранилище (S3):**
   - Автоматически загружаются в Yandex Object Storage
   - Путь в S3: `exports/products-export-YYYY-MM-DD.csv`
   - Публичные URL доступны через CDN

**Логи:**
- `web/logs/product-export.log` - содержит информацию о выгрузке и S3 URLs

**Отключение автоматической выгрузки:**
Добавьте в `.env`:
```bash
DISABLE_CRON_PRODUCT_EXPORT=true
```

### Как коллеги могут получить файлы

#### Вариант 1: Прямая ссылка из S3 (рекомендуется)

После каждой выгрузки файлы автоматически загружаются в S3. URL файлов логируются в `web/logs/product-export.log`:

```
☁️  File uploaded to S3: https://your-cdn-domain.com/exports/products-export-2025-01-15.csv
☁️  File uploaded to S3: https://your-cdn-domain.com/exports/products-export-2025-01-15.xml
```

**Коллеги могут:**
1. Получить ссылку из логов или от администратора
2. Скачать файл напрямую по ссылке
3. Использовать ссылку в автоматизированных системах

#### Вариант 2: API для получения списка файлов

**Получить список всех доступных экспортов:**
```bash
GET /api/admin/products/export/list
Authorization: Bearer <admin_token>
```

**Ответ:**
```json
{
  "success": true,
  "exports": [
    {
      "filename": "products-export-2025-01-15.csv",
      "format": "csv",
      "date": "2025-01-15",
      "size": 123456,
      "s3Url": "https://your-cdn-domain.com/exports/products-export-2025-01-15.csv",
      "localPath": "/path/to/exports/products-export-2025-01-15.csv"
    }
  ],
  "count": 1
}
```

**Скачать конкретный файл:**
```bash
GET /api/admin/products/export/download/products-export-2025-01-15.csv
Authorization: Bearer <admin_token>
```

#### Вариант 3: Доступ к файлам на сервере

Если у коллег есть доступ к серверу:
```bash
# Найти последние экспорты
ls -lth /var/www/marinaobuv/web/exports/products-export-*.csv

# Скачать через SCP
scp user@server:/var/www/marinaobuv/web/exports/products-export-2025-01-15.csv ./
```

#### Вариант 4: Настроить автоматическую отправку

Можно настроить автоматическую отправку файлов по email или в другие системы после выгрузки (требует дополнительной настройки).

### Ручной экспорт через API

#### Экспорт всех товаров (CSV)
```bash
GET /api/admin/products/export?format=csv
```

#### Экспорт всех товаров (XML)
```bash
GET /api/admin/products/export?format=xml
```

#### Экспорт только новых товаров (с момента последней выгрузки)
```bash
GET /api/admin/products/export?format=csv&onlyNew=true
```

#### Получить метаданные без скачивания файла
```bash
GET /api/admin/products/export?format=csv&download=false
```

**Требования:**
- Авторизация обязательна
- Роль: `ADMIN` или `EXPORT_MANAGER`

### Программный экспорт

```typescript
import { exportProducts, getLastExportDate, saveLastExportDate } from '@/lib/services/product-export-service';

// Экспорт всех товаров
const result = await exportProducts({
  format: 'csv',
  outputPath: '/path/to/export.csv'
});

// Экспорт только новых товаров
const lastExport = getLastExportDate();
const result = await exportProducts({
  format: 'csv',
  onlyNew: true,
  lastExportDate: lastExport || undefined
});

// Сохранить дату последнего экспорта
saveLastExportDate(new Date());
```

## Структура экспортируемых данных

### Поля товара

| Поле | Описание | Пример |
|------|----------|--------|
| ID | Уникальный идентификатор товара | `clx123...` |
| Название | Название товара | `Туфли кожаные` |
| Артикул | Артикул товара | `ART-12345` |
| Категория | Путь категории | `/женская-обувь/туфли` |
| Цена (руб.) | Цена за пару | `2500` |
| Валюта | Валюта цены | `RUB` |
| Материал | Материал изготовления | `Кожа` |
| Пол | Пол | `FEMALE`, `MALE` |
| Сезон | Сезон | `SPRING`, `SUMMER`, `AUTUMN`, `WINTER` |
| Описание | Описание товара | `Описание...` |
| Размеры | Доступные размеры | `36, 37, 38` |
| Изображения | URL изображений через запятую | `https://...` |
| Активен | Статус активности | `Да` / `Нет` |
| Дата создания | ISO дата создания | `2025-01-15T10:30:00.000Z` |
| Дата обновления | ISO дата обновления | `2025-01-15T10:30:00.000Z` |
| URL | URL товара на сайте | `https://marina-obuv.ru/products/slug` |

### Какие товары экспортируются

Экспортируются только активные товары (`isActive: true`), которые:
- Обработаны парсером (`batchProcessingStatus: 'completed'`)
- ИЛИ созданы вручную (`source: 'MANUAL'`)
- ИЛИ импортированы из агрегатора (`source: 'AG'`)

## Интеграция с Bitrix

### Импорт CSV в Bitrix

1. Скачайте файл `products-export-YYYY-MM-DD.csv`
2. В Bitrix перейдите в **Торговый каталог → Импорт товаров**
3. Выберите формат **CSV**
4. Загрузите файл
5. Настройте соответствие полей:
   - `ID` → Внешний код товара
   - `Название` → Название
   - `Артикул` → Артикул
   - `Цена (руб.)` → Цена
   - `Категория` → Категория
   - И т.д.

### Импорт XML в Bitrix

1. Скачайте файл `products-export-YYYY-MM-DD.xml`
2. В Bitrix используйте стандартный импорт XML
3. Настройте маппинг полей согласно структуре XML

## Настройка

### Изменение времени выгрузки

Отредактируйте `scripts/cron-jobs.conf`:
```bash
# Изменить время (например, на 03:00)
0 3 * * * cd /var/www/marinaobuv/web && ...
```

Затем переустановите cron задачи:
```bash
./scripts/install-crons.sh
```

### Изменение формата по умолчанию

Отредактируйте `web/src/scripts/product-export-cron.ts` и измените формат в вызовах `exportProducts()`.

### Настройка хранения файлов

По умолчанию файлы сохраняются в `web/exports/`. Чтобы изменить путь, укажите `outputPath` в опциях экспорта.

## Мониторинг

### Просмотр логов

```bash
# Последние записи
tail -f web/logs/product-export.log

# Поиск ошибок
grep ERROR web/logs/product-export.log

# Получить S3 URLs последних экспортов
grep "File uploaded to S3" web/logs/product-export.log | tail -2
```

### Проверка последней выгрузки

Файл `.last-export` в директории `web/exports/` содержит дату последней выгрузки.

### Проверка статуса cron задачи

```bash
# Просмотр всех cron задач
crontab -l | grep product-export

# Проверка последнего запуска (локальные файлы)
ls -lh web/exports/products-export-*.csv

# Проверка файлов в S3 (через API или консоль Yandex Cloud)
```

### Получение ссылок на файлы для коллег

**Способ 1: Из логов**
```bash
# Получить последние S3 URLs
grep "File uploaded to S3" web/logs/product-export.log | tail -2
```

**Способ 2: Через API**
```bash
curl -H "Authorization: Bearer <token>" \
  https://your-domain.com/api/admin/products/export/list
```

**Способ 3: Проверить S3 напрямую**
Файлы находятся в бакете по пути: `exports/products-export-YYYY-MM-DD.csv`

## Устранение неполадок

### Экспорт не выполняется автоматически

1. Проверьте, что cron задача установлена:
   ```bash
   crontab -l | grep product-export
   ```

2. Проверьте логи:
   ```bash
   tail -f web/logs/product-export.log
   ```

3. Убедитесь, что переменная `DISABLE_CRON_PRODUCT_EXPORT` не установлена в `.env`

### Файлы не создаются

1. Проверьте права доступа к директории `web/exports/`:
   ```bash
   mkdir -p web/exports
   chmod 755 web/exports
   ```

2. Проверьте, что есть активные товары для экспорта

### Ошибки при экспорте через API

1. Убедитесь, что вы авторизованы как администратор
2. Проверьте логи сервера
3. Убедитесь, что база данных доступна

## Дополнительная информация

- Экспортируются только активные товары
- Размеры форматируются как список через запятую
- Изображения экспортируются как список URL через запятую
- Первое изображение в списке - основное (isPrimary)
- Старые файлы экспорта автоматически удаляются через 7 дней (локально)
- Файлы автоматически загружаются в S3 для удобного доступа коллег
- S3 URLs публичные и доступны без авторизации (через CDN)

## Настройка доступа для коллег

### Рекомендуемый подход

1. **Автоматическая отправка ссылок:**
   - Настроить уведомления (email/Telegram) с S3 URLs после каждой выгрузки
   - Или предоставить коллегам доступ к API `/api/admin/products/export/list`

2. **Общий доступ к S3:**
   - Настроить публичный доступ к папке `exports/` в S3
   - Предоставить коллегам базовый URL: `https://your-cdn-domain.com/exports/`
   - Они смогут скачивать файлы по шаблону: `products-export-YYYY-MM-DD.csv`

3. **Автоматизация:**
   - Коллеги могут настроить автоматическую загрузку файлов по расписанию
   - Использовать S3 URLs в своих скриптах интеграции

### Безопасность

- S3 URLs публичные, но файлы находятся в отдельной папке `exports/`
- Можно настроить ограничение доступа через CORS или временные ссылки
- Для дополнительной безопасности можно требовать авторизацию через API
